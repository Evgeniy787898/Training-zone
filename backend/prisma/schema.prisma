generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  directUrl         = env("DIRECT_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model Profile {
  id                  String    @id @default(uuid()) @db.Uuid
  telegramId          BigInt    @unique @map("telegram_id")
  firstName           String?   @map("first_name") @db.VarChar(120)
  lastName            String?   @map("last_name") @db.VarChar(120)
  pinHash             String?   @map("pin_hash")
  pinUpdatedAt        DateTime? @map("pin_updated_at") @db.Timestamptz
  goals               Json      @default("{}")
  equipment           String[]  @default([])
  preferences         Json      @default("{}")
  notificationTime    DateTime? @map("notification_time") @db.Time
  timezone            String    @default("Europe/Moscow") @db.VarChar(64)
  notificationsPaused Boolean   @default(false) @map("notifications_paused")
  aiSummary           Json?     @map("ai_summary")           // Compressed full AI context
  aiSummaryUpdatedAt  DateTime? @map("ai_summary_updated_at") @db.Timestamptz
  customInstructions  Json?     @map("custom_instructions")   // Personal AI behavior instructions (PERS-INS-001)
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  sessions                 TrainingSession[]
  trainingPrograms         UserTrainingProgram[]
  trainingSessionExercises TrainingSessionExercise[]
  achievements             Achievement[]
  metrics                  Metric[]
  notes                    AssistantNote[]
  dialogStates             DialogState[]
  dialogEvents             DialogEvent[]
  observabilityEvents      ObservabilityEvent[]
  dailyAdviceSelections    DailyAdviceSelection[]
  exerciseProgress         ExerciseProgress[]
  operationLogs            OperationLog[]
  progressPhotos           ProgressPhoto[]
  bodyScanSessions         BodyScanSession[]
  workoutLogs              WorkoutAuditLog[]
  refreshTokens            RefreshToken[]
  sensitiveAuditLogs       SensitiveAuditLog[]
  favoriteExercises        FavoriteExercise[]
  evolution360Scans        Evolution360Scan[]
  messageFeedback          MessageFeedback[]
  notifications            Notification[]

  @@map("profiles")
}

model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  token     String   @unique @db.VarChar(512)
  profileId String   @map("profile_id") @db.Uuid
  expiresAt DateTime @map("expires_at") @db.Timestamptz
  createdAt DateTime @default(now()) @map("created_at")
  revoked   Boolean  @default(false)
  
  profile   Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId], map: "refresh_tokens_profile_id_idx")
  @@index([token], map: "refresh_tokens_token_idx")
  @@map("refresh_tokens")
}

model TrainingSession {
  id                          String                @id @default(uuid()) @db.Uuid
  profileId                   String                @map("profile_id") @db.Uuid
  plannedAt                   DateTime              @map("planned_at") @db.Timestamptz
  status                      TrainingSessionStatus @default(planned)
  notes                       String?               @db.Text
  createdAt                   DateTime              @default(now()) @map("created_at")
  updatedAt                   DateTime              @updatedAt @map("updated_at")
  disciplineId                String?               @map("discipline_id") @db.Uuid
  programId                   String?               @map("program_id") @db.Uuid
  userProgramId               String?               @map("user_program_id") @db.Uuid
  comment                     String?               @db.Text
  tabataRounds                Int?                  @map("tabata_rounds")
  tabataTotalSeconds          Int?                  @map("tabata_total_seconds")
  workIntervalSeconds         Int?                  @map("work_interval_seconds")
  restIntervalSeconds         Int?                  @map("rest_interval_seconds")
  restBetweenSetsSeconds      Int?                  @map("rest_between_sets_seconds")
  restBetweenExercisesSeconds Int?                  @map("rest_between_exercises_seconds")

  profile          Profile                   @relation(fields: [profileId], references: [id], onDelete: Cascade)
  discipline       TrainingDiscipline?       @relation(fields: [disciplineId], references: [id])
  program          TrainingProgram?          @relation(fields: [programId], references: [id])
  userProgram      UserTrainingProgram?      @relation(fields: [userProgramId], references: [id])
  exercises        TrainingSessionExercise[]
  exerciseProgress ExerciseProgress[]

  @@index([profileId, plannedAt])
  @@index([profileId, status, plannedAt(sort: Desc)], map: "training_sessions_profile_status_planned_idx")
  @@index([profileId, programId, userProgramId], map: "training_sessions_program_bindings_idx")
  @@map("training_sessions")
}

model TrainingSessionExercise {
  id                       String   @id @default(uuid()) @db.Uuid
  sessionId                String   @map("session_id") @db.Uuid
  profileId                String   @map("profile_id") @db.Uuid
  exerciseId               String?  @map("exercise_id") @db.Uuid
  exerciseKey              String   @map("exercise_key") @db.VarChar(64)
  exerciseLevelId          String?  @map("exercise_level_id") @db.Uuid
  levelCode                String   @default("") @map("level_code") @db.VarChar(64)
  disciplineId             String?  @map("discipline_id") @db.Uuid
  programId                String?  @map("program_id") @db.Uuid
  userProgramId            String?  @map("user_program_id") @db.Uuid
  orderIndex               Int?     @map("order_index")
  targetSets               Int?     @map("target_sets")
  targetReps               Int?     @map("target_reps")
  targetDurationSeconds    Int?     @map("target_duration_seconds")
  completedSets            Int?     @map("completed_sets")
  completedReps            Int?     @map("completed_reps")
  completedDurationSeconds Int?     @map("completed_duration_seconds")
  createdAt                DateTime @default(now()) @map("created_at")
  updatedAt                DateTime @updatedAt @map("updated_at")

  session       TrainingSession      @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  profile       Profile              @relation(fields: [profileId], references: [id], onDelete: Cascade)
  exercise      Exercise?            @relation(fields: [exerciseId], references: [id])
  exerciseLevel ExerciseLevel?       @relation(fields: [exerciseLevelId], references: [id])
  discipline    TrainingDiscipline?  @relation(fields: [disciplineId], references: [id])
  program       TrainingProgram?     @relation(fields: [programId], references: [id])
  userProgram   UserTrainingProgram? @relation(fields: [userProgramId], references: [id])

  @@unique([sessionId, exerciseKey, levelCode], map: "training_session_exercises_session_key_level_uidx")
  @@index([sessionId], map: "training_session_exercises_session_id_idx")
  @@index([sessionId, orderIndex], map: "training_session_exercises_session_order_idx")
  @@index([profileId, sessionId], map: "training_session_exercises_profile_session_idx")
  @@index([programId, userProgramId], map: "training_session_exercises_program_idx")
  @@index([exerciseKey], map: "training_session_exercises_exercise_idx")
  @@map("training_session_exercises")
}

model ExerciseProgress {
  id            String   @id @default(uuid()) @db.Uuid
  sessionId     String   @map("session_id") @db.Uuid
  profileId     String   @map("profile_id") @db.Uuid
  exerciseKey   String   @map("exercise_key")
  levelTarget   String?  @map("level_target")
  levelResult   String?  @map("level_result")
  volumeTarget  Int?     @map("volume_target")
  volumeActual  Int?     @map("volume_actual")
  rpe           Decimal? @db.Decimal(3, 1)
  notes         String?
  decision      String?
  streakSuccess Int      @default(0) @map("streak_success")
  createdAt     DateTime @default(now()) @map("created_at")

  session TrainingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  profile Profile         @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([sessionId], map: "exercise_progress_session_id_idx")
  @@index([profileId, exerciseKey, createdAt], map: "exercise_progress_profile_exercise_idx")
  @@map("exercise_progress")
}

model Metric {
  id         String   @id @default(uuid()) @db.Uuid
  profileId  String   @map("profile_id") @db.Uuid
  metricType String   @map("metric_type")
  value      Decimal  @db.Decimal
  recordedAt DateTime @default(now()) @map("recorded_at") @db.Timestamptz
  source     String?
  unit       String?

  profile Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId, metricType], map: "metrics_profile_id_metric_type_idx")
  @@index([profileId, recordedAt], map: "metrics_profile_id_recorded_at_idx")
  @@map("metrics")
}

model Achievement {
  id            String   @id @default(uuid()) @db.Uuid
  profileId     String   @map("profile_id") @db.Uuid
  title         String
  description   String?
  awardedAt     DateTime @default(now()) @map("awarded_at") @db.Timestamptz
  triggerSource String?  @map("trigger_source")

  profile Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId], map: "achievements_profile_id_idx")
  @@index([profileId, awardedAt], map: "achievements_profile_id_awarded_at_idx")
  @@map("achievements")
}

model DailyAdvice {
  id         String   @id
  adviceType String   @map("advice_type") @db.VarChar(32)
  shortText  String   @map("short_text")
  fullText   String   @map("full_text")
  ideas      Json     @default("[]")
  theme      String?  @db.VarChar(64)
  iconName   String?  @map("icon_name") @db.VarChar(64)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  selections DailyAdviceSelection[]

  @@index([adviceType], map: "daily_advice_advice_type_idx")
  @@map("daily_advice")
}

model DailyAdviceSelection {
  id         String   @id @default(uuid()) @db.Uuid
  profileId  String   @map("profile_id") @db.Uuid
  date       DateTime @db.Date
  adviceId   String   @map("advice_id")
  selectedAt DateTime @default(now()) @map("selected_at") @db.Timestamptz

  profile Profile     @relation(fields: [profileId], references: [id], onDelete: Cascade)
  advice  DailyAdvice @relation(fields: [adviceId], references: [id], onDelete: Cascade)

  @@unique([profileId, date], map: "daily_advice_selection_profile_id_date_key")
  @@index([profileId, date], map: "daily_advice_selection_profile_id_date_idx")
  @@map("daily_advice_selection")
}

model AssistantNote {
  id        String   @id @default(uuid()) @db.Uuid
  profileId String   @map("profile_id") @db.Uuid
  title     String?
  content   String
  tags      String[]
  source    String   @default("chat") @db.VarChar(32)
  metadata  Json     @default("{}")
  createdAt DateTime @default(now()) @map("created_at")

  profile Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId], map: "assistant_notes_profile_id_idx")
  @@index([profileId, createdAt(sort: Desc)], map: "assistant_notes_profile_id_created_at_idx")
  @@map("assistant_notes")
}

model DialogState {
  id           String    @id @default(uuid()) @db.Uuid
  profileId    String    @map("profile_id") @db.Uuid
  stateType    String    @map("state_type") @db.VarChar(64)
  statePayload Json      @map("state_payload")
  expiresAt    DateTime? @map("expires_at") @db.Timestamptz
  updatedAt    DateTime  @default(now()) @map("updated_at")

  profile Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([profileId, stateType], map: "dialog_states_profile_id_state_type_key")
  @@index([stateType, updatedAt], map: "dialog_states_state_type_updated_at_idx")
  @@index([stateType, expiresAt], map: "dialog_states_state_type_expires_at_idx")
  @@map("dialog_states")
}

model DialogEvent {
  id                String   @id @default(uuid()) @db.Uuid
  profileId         String?  @map("profile_id") @db.Uuid
  eventType         String   @map("event_type") @db.VarChar(64)
  payload           Json     @default("{}")
  abGroup           String?  @map("ab_group") @db.VarChar(32)
  responseLatencyMs Int?     @map("response_latency_ms")
  createdAt         DateTime @default(now()) @map("created_at")

  profile Profile? @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId], map: "dialog_events_profile_id_idx")
  @@map("dialog_events")
}

model OperationLog {
  id          String   @id @default(uuid()) @db.Uuid
  profileId   String?  @map("profile_id") @db.Uuid
  action      String   @db.VarChar(64)
  status      String   @db.VarChar(32)
  payloadHash String?  @map("payload_hash")
  errorCode   String?  @map("error_code") @db.VarChar(64)
  createdAt   DateTime @default(now()) @map("created_at")

  profile Profile? @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId, createdAt(sort: Desc)], map: "operation_log_profile_created_at_idx")
  @@index([status, createdAt(sort: Desc)], map: "operation_log_status_created_at_idx")
  @@map("operation_log")
}

model ObservabilityEvent {
  id         String   @id @default(uuid()) @db.Uuid
  profileId  String?  @map("profile_id") @db.Uuid
  category   String   @db.VarChar(64)
  severity   String   @db.VarChar(32)
  payload    Json     @default("{}")
  traceId    String?  @map("trace_id")
  recordedAt DateTime @default(now()) @map("recorded_at") @db.Timestamptz
  handled    Boolean  @default(false)

  profile Profile? @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId], map: "observability_events_profile_id_idx")
  @@index([category, severity, recordedAt(sort: Desc)], map: "observability_events_category_severity_recorded_at_idx")
  @@map("observability_events")
}

model TrainingProgram {
  id           String   @id @default(uuid()) @db.Uuid
  disciplineId String?  @map("discipline_id") @db.Uuid
  name         String   @unique @db.VarChar(160)
  description  String?
  frequency    Int      @default(6)
  restDay      String?  @map("rest_day") @db.VarChar(16)
  programData  Json     @map("program_data")
  isActive     Boolean? @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  discipline       TrainingDiscipline?       @relation(fields: [disciplineId], references: [id])
  exercises        Exercise[]
  userPrograms     UserTrainingProgram[]
  sessions         TrainingSession[]
  sessionExercises TrainingSessionExercise[]

  @@index([disciplineId], map: "training_programs_discipline_id_idx")
  @@index([isActive], map: "training_programs_is_active_idx")
  @@index([disciplineId, isActive], map: "training_programs_discipline_id_is_active_idx")
  @@index([disciplineId, name], map: "training_programs_discipline_id_name_idx")
  @@index([disciplineId, isActive, id], map: "training_programs_discipline_id_is_active_id_idx")
  @@map("training_programs")
}

model TrainingDiscipline {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique @db.VarChar(160)
  description String?
  imageUrl    String?  @map("image_url")
  isActive    Boolean? @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @map("updated_at")

  programs         TrainingProgram[]
  exerciseLevels   ExerciseLevel[]
  userPrograms     UserTrainingProgram[]
  sessions         TrainingSession[]
  sessionExercises TrainingSessionExercise[]

  @@index([isActive], map: "training_disciplines_is_active_idx")
  @@index([isActive, name], map: "training_disciplines_is_active_name_idx")
  @@index([isActive, id], map: "training_disciplines_is_active_id_idx")
  @@map("training_disciplines")
}

model Exercise {
  id          String   @id @default(uuid()) @db.Uuid
  exerciseKey String   @unique @map("exercise_key") @db.VarChar(64)
  title       String   @db.VarChar(160)
  focus       String?
  description String?
  cue         String?
  equipment   String[] @default([])
  programId   String?  @map("program_id") @db.Uuid
  iconUrl     String?  @map("icon_url")
  iconUrlHover String? @map("icon_url_hover")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  levels           ExerciseLevel[]
  program          TrainingProgram?          @relation(fields: [programId], references: [id])
  sessionExercises TrainingSessionExercise[]

  @@index([programId], map: "exercises_program_id_idx")
  @@index([programId, title], map: "exercises_program_id_title_idx")
  @@map("exercises")
}

model ExerciseLevel {
  id           String   @id @default(uuid()) @db.Uuid
  exerciseKey  String   @map("exercise_key")
  level        String   @db.VarChar(64)
  title        String
  sets         Int?
  reps         Int?
  orderIndex   Int?     @map("order_index")
  execution    String?
  technique    String?
  improvement  String?
  imageUrl     String?  @map("image_url")
  imageUrl2    String?  @map("image_url_2")
  imageUrl3    String?  @map("image_url_3")
  disciplineId String?  @map("discipline_id") @db.Uuid
  isActive     Boolean? @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @default(now()) @map("updated_at")

  exercise         Exercise                  @relation(fields: [exerciseKey], references: [exerciseKey])
  discipline       TrainingDiscipline?       @relation(fields: [disciplineId], references: [id])
  sessionExercises TrainingSessionExercise[]

  @@unique([exerciseKey, level], map: "exercise_levels_exercise_key_level_key")
  @@index([exerciseKey], map: "exercise_levels_exercise_key_idx")
  @@index([exerciseKey, orderIndex], map: "exercise_levels_order_idx")
  @@index([exerciseKey, isActive], map: "exercise_levels_exercise_key_is_active_idx")
  @@index([exerciseKey, orderIndex, level], map: "exercise_levels_exercise_key_order_level_idx")
  @@index([disciplineId], map: "exercise_levels_discipline_id_idx")
  @@index([disciplineId, isActive], map: "exercise_levels_discipline_id_is_active_idx")
  @@map("exercise_levels")
}

model UserTrainingProgram {
  id            String   @id @default(uuid()) @db.Uuid
  profileId     String   @map("profile_id") @db.Uuid
  disciplineId  String   @map("discipline_id") @db.Uuid
  programId     String   @map("program_id") @db.Uuid
  initialLevels Json?    @map("initial_levels")
  currentLevels Json?    @map("current_levels")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  profile          Profile                   @relation(fields: [profileId], references: [id], onDelete: Cascade)
  discipline       TrainingDiscipline        @relation(fields: [disciplineId], references: [id], onDelete: Cascade)
  program          TrainingProgram           @relation(fields: [programId], references: [id], onDelete: Cascade)
  sessions         TrainingSession[]
  sessionExercises TrainingSessionExercise[]

  @@unique([profileId], map: "user_training_programs_profile_id_key")
  @@index([profileId], map: "user_training_programs_profile_id_idx")
  @@index([disciplineId], map: "user_training_programs_discipline_id_idx")
  @@index([programId], map: "user_training_programs_program_id_idx")
  @@index([profileId, isActive], map: "user_training_programs_profile_id_is_active_idx")
  @@map("user_training_programs")
}

enum TrainingSessionStatus {
  planned
  in_progress
  done
  skipped
}

model ProgressPhoto {
  id         String   @id @default(uuid()) @db.Uuid
  profileId  String   @map("profile_id") @db.Uuid
  imageUrl   String   @map("image_url")
  thumbnail  String?
  capturedAt DateTime @default(now()) @map("captured_at")
  note       String?  @db.VarChar(500)
  weightKg   Float?   @map("weight_kg")
  bodyFat    Float?   @map("body_fat")
  
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  profile    Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId, capturedAt], map: "progress_photos_profile_id_captured_at_idx")
  @@map("progress_photos")
}

model BodyScanSession {
  id         String   @id @default(uuid()) @db.Uuid
  profileId  String   @map("profile_id") @db.Uuid
  
  frontImageUrl String @map("front_image_url")
  backImageUrl  String @map("back_image_url")
  leftImageUrl  String @map("left_image_url")
  rightImageUrl String @map("right_image_url")

  heightCm   Float    @map("height_cm")
  weightKg   Float    @map("weight_kg")
  bodyFat    Float?   @map("body_fat")
  
  analysis   Json?    @map("analysis") // Stores AI insights (body type, posture, estimated fat)
  
  scannedAt  DateTime @default(now()) @map("scanned_at")
  createdAt  DateTime @default(now()) @map("created_at")

  profile    Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId, scannedAt])
  @@map("body_scan_sessions")
}

model WorkoutAuditLog {
  id          String   @id @default(uuid()) @db.Uuid
  profileId   String   @map("profile_id") @db.Uuid
  entityType  String   @map("entity_type") @db.VarChar(32) // 'TrainingSession', 'ExerciseProgress'
  entityId    String   @map("entity_id") @db.Uuid
  action      String   @db.VarChar(16) // 'CREATE', 'UPDATE', 'DELETE'
  
  // Store the FULL state of the object BEFORE the change (for rollback)
  previousState Json?  @map("previous_state")
  
  // Store the changeset or new state
  newState      Json?  @map("new_state")
  
  changedAt   DateTime @default(now()) @map("changed_at")
  
  profile     Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId, entityId])
  @@index([changedAt])
  @@map("workout_audit_log")
}

model SensitiveAuditLog {
  id          String   @id @default(uuid()) @db.Uuid
  profileId   String?  @map("profile_id") @db.Uuid
  event       String   @db.VarChar(64) // e.g., 'PIN_CHANGE', 'LOGIN_SUCCESS', 'LOGIN_FAILURE', 'PROFILE_UPDATE'
  status      String   @db.VarChar(32) // 'SUCCESS', 'FAILURE'
  ip          String?  @db.Inet
  userAgent   String?  @map("user_agent")
  metadata    Json?    @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")

  profile     Profile? @relation(fields: [profileId], references: [id], onDelete: SetNull)

  @@index([profileId, event, createdAt(sort: Desc)], map: "sensitive_audit_log_profile_event_idx")
  @@index([event, createdAt(sort: Desc)], map: "sensitive_audit_log_event_idx")
  @@map("sensitive_audit_log")
}

model FavoriteExercise {
  id          String   @id @default(uuid()) @db.Uuid
  profileId   String   @map("profile_id") @db.Uuid
  exerciseKey String   @map("exercise_key") @db.VarChar(64)
  createdAt   DateTime @default(now()) @map("created_at")

  profile     Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([profileId, exerciseKey], map: "favorite_exercises_profile_exercise_key")
  @@index([profileId], map: "favorite_exercises_profile_id_idx")
  @@map("favorite_exercises")
}

model Evolution360Scan {
  id           String   @id @default(uuid()) @db.Uuid
  profileId    String   @map("profile_id") @db.Uuid
  scanType     String   @map("scan_type") @db.VarChar(16)  // 'current' | 'goal'
  frameCount   Int      @map("frame_count")
  uploadedAt   DateTime @default(now()) @map("uploaded_at") @db.Timestamptz
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  profile      Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  frames       Evolution360Frame[]

  @@unique([profileId, scanType], map: "evolution_360_scans_profile_type_key")
  @@index([profileId, scanType], map: "evolution_360_scans_profile_type_idx")
  @@map("evolution_360_scans")
}

model Evolution360Frame {
  id           String   @id @default(uuid()) @db.Uuid
  scanId       String   @map("scan_id") @db.Uuid
  frameIndex   Int      @map("frame_index")
  imageUrl     String   @map("image_url")
  createdAt    DateTime @default(now()) @map("created_at")

  scan         Evolution360Scan @relation(fields: [scanId], references: [id], onDelete: Cascade)

  @@unique([scanId, frameIndex], map: "evolution_360_frames_scan_frame_key")
  @@index([scanId], map: "evolution_360_frames_scan_id_idx")
  @@map("evolution_360_frames")
}

// === AI FEEDBACK FOR MACHINE LEARNING ===
model MessageFeedback {
  id            String   @id @default(uuid()) @db.Uuid
  profileId     String   @map("profile_id") @db.Uuid
  messageId     String   @unique @map("message_id") // UUID of the chat message
  
  // User reaction
  reaction      String   @db.VarChar(10) // 'like', 'dislike', or emoji like 'ðŸ”¥'
  comment       String?  // User comment when disliking
  
  // Context for ML training
  userMessage   String   @map("user_message") // Original user question
  aiResponse    String   @map("ai_response")  // AI response that was rated
  aiMood        String?  @map("ai_mood") @db.VarChar(20) // AI mood when responding
  
  createdAt     DateTime @default(now()) @map("created_at")
  
  profile       Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  @@index([profileId], map: "message_feedback_profile_id_idx")
  @@index([reaction], map: "message_feedback_reaction_idx")
  @@map("message_feedback")
}

model Notification {
  id        String   @id @default(uuid()) @db.Uuid
  profileId String   @map("profile_id") @db.Uuid
  type      String   @db.VarChar(32) // 'training_reminder', 'motivation', 'achievement', 'weekly_report', 'daily_tip'
  title     String
  message   String
  data      Json?    @default("{}")
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  profile   Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId], map: "notifications_profile_id_idx")
  @@map("notifications")
}

// === AI SELF-LEARNING SYSTEM (SELF-001, ML-001, LEARN-001) ===

// Stores all AI interactions for learning
model AIInteraction {
  id              String   @id @default(uuid()) @db.Uuid
  profileId       String   @map("profile_id") @db.Uuid
  userMessage     String   @map("user_message") @db.Text
  aiResponse      String   @map("ai_response") @db.Text
  intent          String?  @db.VarChar(64)
  rating          String?  @db.VarChar(16) // 'positive', 'negative', 'neutral'
  reactionEmoji   String?  @map("reaction_emoji") @db.VarChar(10)
  feedbackComment String?  @map("feedback_comment") @db.Text
  latencyMs       Int?     @map("latency_ms")
  tokensUsed      Int?     @map("tokens_used")
  model           String?  @db.VarChar(64)
  promptVersion   String?  @map("prompt_version") @db.VarChar(32)
  metadata        Json?    @default("{}")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([profileId], map: "ai_interactions_profile_id_idx")
  @@index([rating], map: "ai_interactions_rating_idx")
  @@index([intent], map: "ai_interactions_intent_idx")
  @@index([createdAt], map: "ai_interactions_created_at_idx")
  @@map("ai_interactions")
}

// Auto-generated and user-provided instructions that improve AI behavior
model AILearnedInstruction {
  id                  String   @id @default(uuid()) @db.Uuid
  profileId           String?  @map("profile_id") @db.Uuid // null = global instruction
  content             String   @db.Text
  category            String   @db.VarChar(32) // 'response_style', 'topic_handling', 'error_recovery', 'personalization', 'safety'
  confidence          Float    @default(0.5) // 0.0 - 1.0
  successRate         Float    @default(0.5) @map("success_rate") // ratio of positive feedback when used
  usageCount          Int      @default(0) @map("usage_count")
  source              String   @db.VarChar(32) // 'auto_generated', 'user_feedback', 'admin', 'baseline'
  isActive            Boolean  @default(true) @map("is_active")
  parentInstructionId String?  @map("parent_instruction_id") @db.Uuid
  metadata            Json?    @default("{}")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  @@index([profileId], map: "ai_learned_instructions_profile_id_idx")
  @@index([isActive, confidence], map: "ai_learned_instructions_active_confidence_idx")
  @@index([category], map: "ai_learned_instructions_category_idx")
  @@map("ai_learned_instructions")
}

// Experience replay buffer for few-shot learning
model AIExperienceBuffer {
  id           String   @id @default(uuid()) @db.Uuid
  profileId    String   @unique @map("profile_id") @db.Uuid
  interactions Json     @default("[]") // Array of BufferedInteraction
  maxSize      Int      @default(1000) @map("max_size")
  createdAt    DateTime @default(now()) @map("created_at")
  lastCleanup  DateTime @default(now()) @map("last_cleanup")

  @@map("ai_experience_buffers")
}

// User learning profile for personalization
model AIUserLearningProfile {
  id                 String   @id @default(uuid()) @db.Uuid
  profileId          String   @unique @map("profile_id") @db.Uuid
  communicationStyle Json     @default("{}") @map("communication_style")
  topics             Json     @default("{}")
  patterns           Json     @default("{}")
  emotionalPatterns  Json     @default("{}") @map("emotional_patterns")
  lastUpdated        DateTime @default(now()) @map("last_updated")

  @@map("ai_user_learning_profiles")
}

// Failure patterns for generating corrective instructions
model AIFailurePattern {
  id          String   @id @default(uuid()) @db.Uuid
  profileId   String   @map("profile_id") @db.Uuid
  category    String   @db.VarChar(32) // 'factual_error', 'length_issue', 'tone_issue', etc.
  confidence  Float    @default(0.5)
  userMessage String   @map("user_message") @db.VarChar(500)
  aiResponse  String   @map("ai_response") @db.VarChar(500)
  comment     String?  @db.VarChar(500)
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([profileId, category], map: "ai_failure_patterns_profile_category_idx")
  @@index([createdAt], map: "ai_failure_patterns_created_at_idx")
  @@map("ai_failure_patterns")
}

// Music tracks for training sessions
model MusicTrack {
  id          String   @id @default(uuid()) @db.Uuid
  profileId   String   @map("profile_id") @db.Uuid
  name        String   @db.VarChar(255)
  fileName    String   @map("file_name") @db.VarChar(255)
  storagePath String   @map("storage_path") @db.VarChar(512)
  storageUrl  String   @map("storage_url") @db.VarChar(1024)
  duration    Int?     // Duration in seconds
  fileSize    Int?     @map("file_size") // In bytes
  mimeType    String?  @map("mime_type") @db.VarChar(64)
  uploadedAt  DateTime @default(now()) @map("uploaded_at")
  
  @@index([profileId], map: "music_tracks_profile_id_idx")
  @@index([profileId, uploadedAt], map: "music_tracks_profile_uploaded_idx")
  @@map("music_tracks")
}

// Detailed per-set results for exercises
model ExerciseSetResult {
  id                  String   @id @default(uuid()) @db.Uuid
  profileId           String   @map("profile_id") @db.Uuid
  sessionId           String   @map("session_id") @db.Uuid
  exerciseKey         String   @map("exercise_key") @db.VarChar(64)
  setIndex            Int      @map("set_index")
  targetReps          Int      @map("target_reps")
  actualReps          Int      @map("actual_reps")
  rpe                 Int?     // 1-10 scale
  durationSeconds     Int?     @map("duration_seconds")
  restAfterSeconds    Int?     @map("rest_after_seconds")
  createdAt           DateTime @default(now()) @map("created_at")
  
  @@unique([sessionId, exerciseKey, setIndex], map: "exercise_set_results_session_exercise_set_uidx")
  @@index([profileId, sessionId], map: "exercise_set_results_profile_session_idx")
  @@index([sessionId, exerciseKey], map: "exercise_set_results_session_exercise_idx")
  @@map("exercise_set_results")
}
