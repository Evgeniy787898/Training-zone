# Supabase Database
DATABASE_URL="postgresql://postgres:[YOUR-PASSWORD]@db.[YOUR-PROJECT-REF].supabase.co:6543/postgres?pgbouncer=true&connection_limit=6&pool_timeout=60"
DATABASE_POOL_URL=""
DATABASE_DIRECT_URL=""
DIRECT_URL="postgresql://postgres:[YOUR-PASSWORD]@db.[YOUR-PROJECT-REF].supabase.co:5432/postgres"
SHADOW_DATABASE_URL="postgresql://postgres:[YOUR-PASSWORD]@db.[YOUR-PROJECT-REF].supabase.co:5432/postgres?schema=shadow"
SUPABASE_URL="https://[YOUR-PROJECT-REF].supabase.co"
SUPABASE_ANON_KEY="[YOUR-ANON-KEY]"
SUPABASE_SERVICE_KEY="[YOUR-SERVICE-KEY]"
SUPABASE_ANON_KEY_FILE="" # если используется Docker Secret, укажите путь к файлу с ключом
SUPABASE_SERVICE_KEY_FILE="" # если используется Docker Secret, укажите путь к файлу с ключом
PRISMA_POOL_URL=""
PRISMA_DIRECT_URL=""
PRISMA_RUNTIME_URL="" # опционально: укажите DIRECT_URL для обхода PgBouncer
PRISMA_PREFER_POOL=true
PRISMA_POOL_WARMUP_TIMEOUT_MS=5000
PRISMA_POOL_FALLBACK_ENABLED=true
PRISMA_CONNECTION_HEADROOM=1
PRISMA_MAX_CONCURRENCY=1
PRISMA_QUEUE_WARN_SIZE=25
# Slow query logging & analysis
PRISMA_SLOW_QUERY_THRESHOLD_MS=250
PRISMA_SLOW_QUERY_HISTORY_LIMIT=200
PRISMA_SLOW_QUERY_LOG_PATH=logs/prisma-slow-queries.ndjson
PRISMA_SLOW_QUERY_PARAMS_PREVIEW=500
PRISMA_SLOW_QUERY_SAMPLE_RATE=0
PRISMA_SLOW_QUERY_CAPTURE_STACK=false
PRISMA_SLOW_QUERY_MONITORING_ENABLED=true
PRISMA_SLOW_QUERY_MONITORING_SEVERITY=warning
# Structured application logging
LOG_ENABLED=true
LOG_LEVEL=info
LOG_ECHO_TO_CONSOLE=true
LOG_FILE_PATH=logs/application.ndjson
LOG_FILE_MAX_BYTES=5242880
LOG_FILE_MAX_BACKUPS=5
LOG_ALERT_ON_ERROR=true
LOG_REDACT_KEYS=authorization,cookie,token,refreshtoken,accesstoken,pin,password,secret
LOG_REDACT_PATTERNS=

# Performance metrics
PERF_METRICS_LATENCY_SAMPLE_SIZE=500
PERF_METRICS_THROUGHPUT_WINDOW_MS=60000
PERF_METRICS_SLOW_THRESHOLD_MS=2000
PERF_METRICS_SLOW_SAMPLE_SIZE=20
ANOMALY_LATENCY_WARN_MS=3000
ANOMALY_LATENCY_CRITICAL_MS=8000
ANOMALY_ERROR_RATE_WARN_BPS=50
ANOMALY_ERROR_RATE_CRITICAL_BPS=200
ANOMALY_CPU_WARN_PERCENT=70
ANOMALY_CPU_CRITICAL_PERCENT=90
ANOMALY_MEMORY_WARN_PERCENT=75
ANOMALY_MEMORY_CRITICAL_PERCENT=90
METRICS_DASHBOARD_SAMPLE_INTERVAL_MS=60000
METRICS_DASHBOARD_HISTORY_SIZE=120
RESOURCE_METRICS_SAMPLE_INTERVAL_MS=5000
RESOURCE_METRICS_SNAPSHOT_TTL_MS=1000
BUSINESS_METRICS_LOOKBACK_DAYS=14
BUSINESS_METRICS_CACHE_TTL_MS=30000
SLA_SAMPLE_WINDOW_MS=300000
CAPACITY_TARGET_CPU_PERCENT=70
CAPACITY_TARGET_MEMORY_PERCENT=75
CAPACITY_MAX_TPUT_PER_INSTANCE=50
# Materialized view refresh cadence
MATERIALIZED_VIEW_SESSION_VOLUME_REFRESH_MS=60000
MATERIALIZED_VIEW_PROFILE_SUMMARY_REFRESH_MS=300000
MATERIALIZED_VIEW_RPE_REFRESH_MS=120000
# Graceful degradation when DB is unavailable
DATABASE_DEGRADED_COOLDOWN_MS=30000
DATABASE_DEGRADED_RETRY_AFTER_MS=15000
DATABASE_HEALTH_SNAPSHOT_TTL_MS=5000
HEALTH_SNAPSHOT_TTL_MS=5000
HEALTH_MICROSERVICE_TIMEOUT_MS=1500
DATABASE_RETRY_MAX_ATTEMPTS=3
DATABASE_RETRY_INITIAL_DELAY_MS=200
DATABASE_RETRY_MAX_DELAY_MS=2000
DATABASE_RETRY_BACKOFF_MULTIPLIER=2
DATABASE_RETRY_JITTER_RATIO=0.25
# HTTP client (keep-alive/pooling for upstream requests)
HTTP_KEEP_ALIVE=true
HTTP_MAX_CONNECTIONS=50
HTTP_PIPELINING=1
HTTP_CONNECT_TIMEOUT_MS=3000
HTTP_HEADERS_TIMEOUT_MS=15000
HTTP_BODY_TIMEOUT_MS=17000
HTTP_KEEP_ALIVE_TIMEOUT_MS=10000
HTTP_KEEP_ALIVE_MAX_TIMEOUT_MS=60000
# Circuit breaker for external services
CIRCUIT_BREAKER_FAILURE_THRESHOLD=5
CIRCUIT_BREAKER_SUCCESS_THRESHOLD=2
CIRCUIT_BREAKER_OPEN_DURATION_MS=30000
CIRCUIT_BREAKER_HALF_OPEN_MAX_CONCURRENT=1

# Telegram Bot
TELEGRAM_BOT_TOKEN="[YOUR-TELEGRAM-BOT-TOKEN]"
TELEGRAM_WEBHOOK_URL=""
TELEGRAM_ALLOWED_IDS=""
TELEGRAM_WEBAPP_SECRET="[YOUR-TELEGRAM-WEBAPP-SECRET]"
TELEGRAM_BOT_TOKEN_FILE="" # путь до файла с токеном бота (Docker Secret)
TELEGRAM_WEBAPP_SECRET_FILE="" # путь до файла с WebApp секретом (Docker Secret)

# Server
PORT=3001
NODE_ENV=development
APP_ENV=development # development | staging | production — профиль конфигурации (namespace кэша, уровни логов, rate limits)
HOST="0.0.0.0"
WEBAPP_URL="https://[YOUR-WEBAPP-URL]"
MEDIA_BASE_URL="https://api.example.com" # публичный URL backend, используется для построения ссылок /api/media
MEDIA_CDN_BASE_URL="" # домен CDN, который проксирует /api/media (например, https://cdn.example.com)
MEDIA_CDN_SIGNING_SECRET="" # опционально: секрет для подписи ссылок CDN
MEDIA_CDN_SIGNING_PARAM=token
MEDIA_CDN_EXPIRES_PARAM=expires
MEDIA_CDN_SIGNATURE_TTL_SECONDS=3600
# Image processor microservice
IMAGE_PROCESSOR_ENABLED=true
IMAGE_PROCESSOR_URL="http://image-processor:3002"
IMAGE_PROCESSOR_DEFAULT_MAX_WIDTH=1280
IMAGE_PROCESSOR_DEFAULT_MAX_HEIGHT=1280
IMAGE_PROCESSOR_DEFAULT_QUALITY=85
IMAGE_PROCESSOR_DEFAULT_FORMAT=webp
IMAGE_PROCESSOR_ALLOWED_FORMATS=webp,jpeg,png
IMAGE_PROCESSOR_DEFAULT_MODE=contain
IMAGE_PROCESSOR_ALLOWED_MODES=contain,cover,fill,stretch,pad
IMAGE_PROCESSOR_DEFAULT_BACKGROUND=
IMAGE_PROCESSOR_STRIP_METADATA_DEFAULT=true
IMAGE_PROCESSOR_MAX_DIMENSION=2048
IMAGE_PROCESSOR_TIMEOUT_MS=10000
IMAGE_PROCESSOR_CACHE_TTL_SECONDS=21600

# Cache (Redis + in-memory fallback)
CACHE_REDIS_URL="redis://localhost:6379"
CACHE_NAMESPACE=tzona
CACHE_MEMORY_SWEEP_INTERVAL_MS=60000
CACHE_MEMORY_MAX_ENTRIES=5000
CACHE_REDIS_MAX_RETRIES_PER_REQUEST=1
CACHE_REDIS_LAZY_CONNECT=true
CACHE_FALLBACK_ENABLED=true
CACHE_FALLBACK_FAILURE_THRESHOLD=3
CACHE_FALLBACK_COOLDOWN_MS=60000
CACHE_FALLBACK_LOG_THROTTLE_MS=30000
CACHE_STAMPEDE_LOCK_TTL_SECONDS=5
CACHE_STAMPEDE_WAIT_INTERVAL_MS=50
CACHE_STAMPEDE_MAX_WAIT_MS=1500
CACHE_STAMPEDE_MAX_JITTER_SECONDS=10
CACHE_STAMPEDE_MAX_JITTER_PERCENT=15
CACHE_MONITORING_ENABLED=true
CACHE_MONITORING_INTERVAL_MS=60000
CACHE_MONITORING_WARN_THRESHOLD=0.8
CACHE_MONITORING_CRITICAL_THRESHOLD=0.5
CACHE_MONITORING_MIN_SAMPLES=200
CACHE_ASSISTANT_AI_ADVICE_TTL_SECONDS=45
CACHE_ADAPTIVE_TTL_ENABLED=true
CACHE_ADAPTIVE_TTL_FAST_WINDOW_SECONDS=120
CACHE_ADAPTIVE_TTL_SLOW_WINDOW_SECONDS=3600
CACHE_ADAPTIVE_TTL_MIN_MULTIPLIER=0.5
CACHE_ADAPTIVE_TTL_MAX_MULTIPLIER=2
CACHE_COMPRESSION_ENABLED=true
CACHE_COMPRESSION_MIN_SIZE_BYTES=4096
CACHE_COMPRESSION_ENCODING=brotli
CACHE_COMPRESSION_BROTLI_QUALITY=5
CACHE_COMPRESSION_GZIP_LEVEL=6
# Cache versioning (bump versions to invalidate stale data structures without flushing Redis entirely)
CACHE_VERSION_GLOBAL=1
CACHE_VERSION_PROFILE_SUMMARY=1
CACHE_VERSION_ACHIEVEMENTS_PAGE=1
CACHE_VERSION_EXERCISE_CATALOG=1
CACHE_VERSION_EXERCISE_LIST=1
CACHE_VERSION_DAILY_ADVICE_LIST=1
CACHE_VERSION_REPORTS=1
CACHE_VERSION_TRAINING_DISCIPLINES=1
CACHE_VERSION_TRAINING_PROGRAMS=1
CACHE_VERSION_ASSISTANT_NOTES_PAGE=1
CACHE_VERSION_AI_ADVISOR_ADVICE=1

# Microservice clients
AI_ADVISOR_BASE_URL="http://localhost:3003"
AI_ADVISOR_ENABLED=true
AI_ADVISOR_API_TOKEN=""
AI_ADVISOR_TIMEOUT_MS=6000
AI_ADVISOR_CONTEXT_MAX_ENTRIES=6
AI_ADVISOR_CONTEXT_TTL_MS=604800000 # 7 days
AI_ADVISOR_CONTEXT_MAX_CHARS=3200
AI_ADVISOR_LATENCY_WARN_MS=3000
AI_ADVISOR_LATENCY_CRITICAL_MS=6000
AI_ADVISOR_COST_WARN_USD=0.05
AI_ADVISOR_COST_CRITICAL_USD=0.2

ANALYTICS_BASE_URL="http://localhost:3004"
ANALYTICS_ENABLED=false
ANALYTICS_API_TOKEN=""
ANALYTICS_TIMEOUT_MS=5000

# Cache warming
CACHE_WARMING_ENABLED=true
CACHE_WARMING_STARTUP_DELAY_MS=10000
CACHE_WARMING_INTERVAL_MS=900000
CACHE_WARMING_PROFILE_SAMPLE=25
CACHE_WARMING_ACHIEVEMENTS_PAGE_SIZE=20

# Security
# Основной ключ используется для подписи новых токенов, резервные ключи позволяют плавно завершить ротацию.
JWT_SECRET="[LEGACY-JWT-SECRET]" # опционально: прежний секрет для совместимости токенов без kid
JWT_SECRET_KEYS="primary:[CURRENT-SECRET],legacy:[PREVIOUS-SECRET]" # формат id:secret через запятую
JWT_SECRET_ACTIVE_ID=primary
JWT_SECRET_LEGACY_ID=legacy
JWT_SECRET_FILE="" # путь до файла со старым секретом
JWT_SECRET_KEYS_FILE="" # путь до файла с набором id:secret

# Секреты AI Advisor
AI_ADVISOR_API_TOKEN=""
AI_ADVISOR_API_TOKEN_FILE="" # путь до файла с токеном провайдера (например, Docker Secret)
JWT_EXPIRES_IN=30d
JWT_ISSUER="tzona-backend"
JWT_AUDIENCE="tzona-client"
JWT_REVOKED_FALLBACK_TTL_MS=2592000000 # 30 days in ms for revoked token retention fallback
JWT_REVOKED_CLEANUP_INTERVAL_MS=300000 # cleanup revoked token cache every 5 minutes
# Минимум 16 символов; используйте уникальную строку или 32-байтный ключ в base64/hex
ENCRYPTION_SECRET="[YOUR-ENCRYPTION-SECRET]"
ENCRYPTION_SECRET_PREVIOUS="" # опционально: старый ключ для плавной ротации, если нужно читать старые данные
GLOBAL_RATE_LIMIT_MAX=120

# CSRF protection
CSRF_SECRET="[YOUR-CSRF-SECRET-AT-LEAST-32-CHARS]"
CSRF_SECRET_PREVIOUS="" # опционально: предыдущий секрет для плавной ротации токенов
CSRF_TOKEN_TTL=12h
CSRF_TOKEN_REFRESH_THRESHOLD=1h
CSRF_COOKIE_NAME=tzona_csrf
CSRF_COOKIE_SECURE=true
CSRF_COOKIE_SAMESITE=strict
CSRF_HEADER_NAMES="x-csrf-token,x-xsrf-token"

# Request body size limits (accepts integer bytes or shorthand like 512kb/2mb)
REQUEST_BODY_DEFAULT_LIMIT=1mb
REQUEST_BODY_JSON_LIMIT=1mb
REQUEST_BODY_FORM_LIMIT=1mb
REQUEST_BODY_TEXT_LIMIT=256kb
REQUEST_BODY_BINARY_LIMIT=256kb
# Request timeout handling
REQUEST_TIMEOUT_SOFT_MS=12000
REQUEST_TIMEOUT_HARD_MS=15000
REQUEST_TIMEOUT_HEADER=x-request-timeout-ms
# Response compression
COMPRESSION_DISABLED=false
COMPRESSION_THRESHOLD_BYTES=1024
COMPRESSION_PREFER_BROTLI=true
COMPRESSION_BROTLI_QUALITY=5
COMPRESSION_GZIP_LEVEL=6
# Content Security Policy
CSP_DIRECTIVES=""
CSP_MODE=append
CSP_REPORT_ONLY=false
PIN_RATE_LIMIT_MAX=10
PIN_MAX_ATTEMPTS=5
PIN_BLOCK_DURATION_MS=900000

# Monitoring & alerting
MONITORING_WEBHOOK_URL=""
MONITORING_WEBHOOK_AUTH_HEADER=""
MONITORING_WEBHOOK_TIMEOUT_MS=5000
MONITORING_ALERT_MIN_SEVERITY=critical
MONITORING_DEDUPE_TTL_MS=60000
MONITORING_TELEGRAM_BOT_TOKEN="" # опционально: используйте отдельного бота для алёртов
MONITORING_TELEGRAM_CHAT_ID=""
ALERT_TELEGRAM_BOT_TOKEN="" # приоритетный токен, если нужно переиспользовать существующего бота
ALERT_TELEGRAM_CHAT_ID=""

# Synthetic monitoring (JSON array or pipe-delimited entries "name|url|type|method|statuses|timeout")
SYNTHETIC_MONITOR_TARGETS=""
SYNTHETIC_MONITOR_DEFAULT_TIMEOUT_MS=5000
# Optional JSON map of default headers, e.g. '{"Authorization":"Bearer ..."}'
SYNTHETIC_MONITOR_DEFAULT_HEADERS=""

# Archiving
ARCHIVE_OPERATION_LOG_DAYS=90
ARCHIVE_OBSERVABILITY_DAYS=60
ARCHIVE_BATCH_SIZE=1000
ARCHIVE_DRY_RUN=false

# Profiling
PROFILE_API_TARGET="http://localhost:3000"
HEAP_SNAPSHOT_DIR=.profiles
HEAP_SNAPSHOT_NAME=
HEAP_SNAPSHOT_DELAY_MS=0

# Assistant Configuration
ASSISTANT_SUCCESS_THRESHOLD=75
ASSISTANT_SLUMP_THRESHOLD=45

# Frontend
FRONTEND_URL="http://localhost:5173"

# Documentation
#OPENAPI_SPEC_PATH="../docs/openapi.yaml"
